# lib_nc-occ 
### Abstraction layer for NextCloud Management Console (occ) 

Python based library for the [occ management](https://docs.nextcloud.com/server/stable/admin_manual/occ_command.html) console on [NextCloud Servers](https://github.com/nextcloud).

### Features:
- Almost complete Nextcloud management console api mirrored into handy python classes.
- Handles [communication](#communicating-with-occ) with occ
- Powerful tool in combination with nc_py_api for your ExApp apps.

### _How it's done_

Bulk of the code has been generated by 2 scripts:
 
 - One script generating the skeletons dicts based on the occ api
 - A second script generating all the class files from those dicts

### _How it works_

Every generated class inherits from a base class that does the greatest

### Installation
**- Pip local**
- Download the latest release here.
- Extract the zip, then

```
python3 pip install path/to/dwn/load
```

**- Pip repo**
- in the workings

**- Build**
- Clone this repository
- cd into it & run

```
make build
```
- then
```
python3 pip install path/to/dwn/lib_nc_occ
```

### _Usage_

- Complete import
```python
from lib_occ import nc_occ

files_api = nc_occ.Files()
files_api.scan()

# Bigger parts of a section are objects
# These are properties

files.object.info()  #object

ff.object.multi.rename_config()  #object & multi


```
- Section & classes import

>[!NOTE]
> Names for classes are composed with this schema:
>
> {prefix}{BaseClass}{Child1}{ChildN}
>
> The full name for the class "appapi:daemon:registry:"
>
> _NcOccAppapiDaemonRegistry_
> 

```python
from lib_occ.nc_occ import Tag, Config
from lib_occ.appapi import NcOccAppiDaemon

tags = Tag()
config = Config()

# Watches for reserved words. Adds "s" at the end 
tags.lists() 
config.imports()

api_daemons = Appapi.daemon
api_daemons.lists()
```

### _Communicating with occ_

Communication with [occ happens through sudo](https://docs.nextcloud.com/server/stable/admin_manual/occ_command.html#occ-command-directory), as you have to impersonate(sudo) **www-data**.
lib_occ executes a subprocess.run with the corresponding path.
In its default state, lib_occ looks for _occ_ in

```bash
/var/www/nextcloud/
```

and then executes

```bash
sudo -u www-data php /var/www/nextcloud/occ
```

If your server has another path, you can either in your python project like this.

```python
from lib_occ.nc_occ
nc_occ.set_occ_dir(/pth/to/your/NxtCloud)
```


#### root / www-data
If your script / application runs on a webserver or directly in Nextcloud, you're good to go as they run under **www-data**

#### sudo

In its initial state after installation, only root has sudo rights.
And rightly so, because

>With great powers comes gereat responsibility 

Running a maintenance script as root which includes lib_occ will not fail, but any other user will.

#### Other users

>[!Caution]
>Be careful about the next steps, as you will be adding a user to the sudoers and edit the rights with visudo
>

There are [different ways](https://linuxconfig.org/sudo-install-usage-and-sudoers-config-file-basics) to give a user sudo rights.
We'll stick with the most "_secure_" way and only grant our _OtherUser_ the privilege to execute php as www-data
With NOPASSWD 

(Needs root privileges)
```bash
visudo
```
Look for the line
>User privilege specification

and add
```bash
OtherUser   ALL=(www-data:www-data) NOPASSWD: /usr/bin/php
```





